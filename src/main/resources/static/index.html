<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>R.O.A.D. Dashboard</title>
    <style>
        /* Layout */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f4f6f8; color: #212529; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 24px; border-radius: 10px; box-shadow: 0 6px 18px rgba(20,30,50,0.06); }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #eef1f4; padding-bottom: 10px; margin-top: 24px;}
        h1 { margin-top: 0; }

        /* Grid for the top controls */
        .grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; align-items: start; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: #fff; padding: 16px; border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 1px 4px rgba(10,20,30,0.03); }

        /* Forms */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .form-group { margin-bottom: 8px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }

        /* Buttons */
        .btn { padding: 10px 14px; font-size: 13px; border: none; border-radius: 6px; cursor: pointer; text-transform: uppercase; font-weight: 700; box-shadow: none; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0062cc; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #bb2d3b; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        .btn-sm { padding: 6px 10px; font-size: 12px; border-radius: 6px; }
        .btn-group { display: flex; gap: 10px; align-items: center; }

        /* Tables */
        .table-responsive { overflow-x: auto; margin-top: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        th, td { padding: 12px; border-bottom: 1px solid #f1f3f5; text-align: left; }
        th { background: #fbfcfd; font-weight: 700; font-size: 13px; }
        tr:nth-child(even) td { background: #fbfdff; }

        /* Log */
        #log-container { background-color: #fbfdff; border: 1px solid #eef1f4; padding: 12px; border-radius: 6px; min-height: 140px; max-height: 320px; overflow-y: auto; }

        /* Status */
        .log-success { color: #2f8f4b; }
        .log-warning { color: #b27600; }
        .log-error { color: #c82333; }
        .log-info { color: #0b5ed7; }
        .status-healthy { color: #198754; font-weight: 700; }
        .status-unhealthy { color: #dc3545; font-weight: 700; }
        .status-inactive { color: #6c757d; font-weight: 700; }
    </style> 
    <!-- <link rel="icon" href="data:,"> -->
</head>
<body>

<div class="container">
    <h1>R.O.A.D. Dashboard</h1>

    <div class="grid">
        <div class="card">
            <h2>서버 관리</h2>
            <form id="add-server-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">서버 이름</label>
                        <input type="text" id="name" placeholder="예: Web Server 1" required>
                    </div>
                    <div class="form-group">
                        <label for="url">URL</label>
                        <input type="text" id="url" placeholder="예: http://localhost:8080" required>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">서버 추가</button>
                    <button type="button" class="btn btn-info btn-sm" onclick="fetchServers()">새로고침</button>
                </div>
            </form>
        </div>
        <div class="card">
            <h2>부하 분산 테스트</h2>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <button onclick="dispatchRequest()" class="btn btn-primary">요청 보내기</button>
                <button onclick="clearLogs()" class="btn btn-warning btn-sm">로그 초기화</button>
            </div>
            <div id="log-container"></div>
        </div>
    </div> 

    <div class="card table-responsive">
        <h2>서버 목록 (DB 상태)</h2>
        <table id="server-list">
            <thead>
            <tr>
                <th>ID</th>
                <th>이름</th>
                <th>URL</th>
                <th>DB 활성</th>
                <th>작업</th>
            </tr>
            </thead>
            <tbody>
            <!-- 서버 목록이 여기에 동적으로 추가됩니다. -->
            </tbody>
        </table>
    </div> 

    <div class="card table-responsive">
        <h2>서버 헬스 상태 (실시간)</h2>
        <table id="server-health-list">
            <thead>
            <tr>
                <th>ID</th>
                <th>이름</th>
                <th>URL</th>
                <th>DB 활성</th>
                <th>헬스 체크</th>
                <th>최근 확인</th>
            </tr>
            </thead>
            <tbody>
            <!-- 서버 헬스 상태가 여기에 동적으로 추가됩니다. -->
            </tbody>
        </table>
    </div> 
</div>

<script>
    const API_BASE_URL = '/api/admin/servers';
    const HEALTH_CHECK_INTERVAL = 5000; // 5초마다 헬스 체크 상태 새로고침

    // 페이지 로드 시 서버 목록 및 헬스 체크 시작
    document.addEventListener('DOMContentLoaded', () => {
        fetchServers();
        startHealthCheckRefresh();
    });

    // 서버 목록 가져오기 (DB 상태)
    async function fetchServers() {
        try {
            const response = await fetch(API_BASE_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const servers = await response.json();
            const serverListBody = document.getElementById('server-list').querySelector('tbody');
            serverListBody.innerHTML = ''; // 목록 초기화
            servers.forEach(server => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${server.id}</td>
                    <td>${server.name}</td>
                    <td>${server.url}</td>
                    <td><span class="${server.active ? 'status-healthy' : 'status-inactive'}">${server.active ? '활성' : '비활성'}</span></td>
                    <td>
                        <button onclick="toggleServerStatus(${server.id}, '${server.name}', '${server.url}', ${!server.active})" class="btn btn-warning btn-sm">상태 ${server.active ? '비활성' : '활성'}</button>
                        <button onclick="deleteServer(${server.id})" class="btn btn-danger btn-sm">삭제</button>
                    </td>
                `;
                serverListBody.appendChild(row);
            });
        } catch (error) {
            logMessage(`서버 목록 로딩 실패: ${error.message}`, 'log-error');
        }
    }

    // 서버 추가
    document.getElementById('add-server-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const name = document.getElementById('name').value;
        const url = document.getElementById('url').value;
        const newServer = { name, url, active: true };

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newServer)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            this.reset(); // 폼 초기화
            fetchServers(); // 목록 새로고침
            logMessage(`서버 추가됨: ${name}`, 'log-success');
        } catch (error) {
            logMessage(`서버 추가 실패: ${error.message}`, 'log-error');
        }
    });

    // 서버 상태 변경 (활성/비활성)
    async function toggleServerStatus(id, name, url, newActiveStatus) {
        const serverToUpdate = { id, name, url, active: newActiveStatus };
        try {
            const response = await fetch(`${API_BASE_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(serverToUpdate)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            fetchServers();
            logMessage(`서버 상태 변경됨: ${name} -> ${newActiveStatus ? '활성' : '비활성'}`, 'log-info');
        } catch (error) {
            logMessage(`서버 상태 변경 실패: ${error.message}`, 'log-error');
        }
    }

    // 서버 삭제
    async function deleteServer(id) {
        if (!confirm(`정말로 ID ${id} 서버를 삭제하시겠습니까?`)) return;
        try {
            const response = await fetch(`${API_BASE_URL}/${id}`, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            fetchServers();
            logMessage(`서버 삭제됨: ID ${id}`, 'log-warning');
        } catch (error) {
            logMessage(`서버 삭제 실패: ${error.message}`, 'log-error');
        }
    }

    // 부하 분산 요청 보내기
    async function dispatchRequest() {
        try {
            const response = await fetch('/api/dispatch');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            logMessage(`요청이 <b>${data.name}</b> (URL: ${data.url}) 으로 성공적으로 전송되었습니다.`, 'log-success');
        } catch (error) {
            logMessage(`API 요청 실패: ${error.message}`, 'log-error');
        }
    }

    // 서버 헬스 상태 가져오기 및 렌더링
    async function fetchServerHealth() {
        try {
            const response = await fetch(`${API_BASE_URL}/health`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const healthStatuses = await response.json();
            renderServerHealth(healthStatuses);
        } catch (error) {
            logMessage(`서버 헬스 상태 로딩 실패: ${error.message}`, 'log-error');
        }
    }

    // 서버 헬스 상태를 테이블에 렌더링
    function renderServerHealth(healthStatuses) {
        const serverHealthListBody = document.getElementById('server-health-list').querySelector('tbody');
        serverHealthListBody.innerHTML = ''; // 목록 초기화

        healthStatuses.forEach(status => {
            const row = document.createElement('tr');
            const healthyClass = status.healthy ? 'status-healthy' : 'status-unhealthy';
            const lastChecked = status.lastCheckedTimestamp ? new Date(status.lastCheckedTimestamp).toLocaleString() : 'N/A';
            row.innerHTML = `
                <td>${status.serverInstance.id}</td>
                <td>${status.serverInstance.name}</td>
                <td>${status.serverInstance.url}</td>
                <td><span class="${status.serverInstance.active ? 'status-healthy' : 'status-inactive'}">${status.serverInstance.active ? '활성(DB)' : '비활성(DB)'}</span></td>
                <td><span class="${healthyClass}">${status.healthy ? '정상' : '비정상'}</span></td>
                <td>${lastChecked}</td>
            `;
            serverHealthListBody.appendChild(row);
        });
    }

    // 주기적으로 헬스 체크 상태 새로고침
    function startHealthCheckRefresh() {
        setInterval(fetchServerHealth, HEALTH_CHECK_INTERVAL);
    }

    // 로그 메시지 표시
    function clearLogs() {
        const logDiv = document.getElementById('log-container');
        if (logDiv) logDiv.innerHTML = '';
    }
    function logMessage(message, className = 'log-info') {
        const logDiv = document.getElementById('log-container');
        const p = document.createElement('p');
        p.className = className;
        p.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
        logDiv.prepend(p); // 최신 메시지가 위로 오도록 prepend 사용
        // 로그가 너무 많아지면 오래된 로그를 제거
        while (logDiv.children.length > 50) {
            logDiv.removeChild(logDiv.lastChild);
        }
    }

</script>
</body>
</html>