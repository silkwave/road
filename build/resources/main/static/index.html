<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>R.O.A.D. Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 40px; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 960px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #dee2e6; text-align: left; }
        th { background-color: #e9ecef; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: calc(100% - 24px); padding: 10px; border: 1px solid #ced4da; border-radius: 4px; }
        .btn { padding: 10px 15px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        #log { background-color: #e9ecef; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; min-height: 100px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .flex-container { display: flex; justify-content: space-between; align-items: flex-start; }
        .flex-child { width: 48%; }
    </style>
</head>
<body>

<div class="container">
    <h1>R.O.A.D. Dashboard</h1>

    <div class="flex-container">
        <div class="flex-child">
            <h2>서버 관리</h2>
            <form id="add-server-form">
                <div class="form-group">
                    <label for="name">서버 이름</label>
                    <input type="text" id="name" placeholder="예: Web Server 1" required>
                </div>
                <div class="form-group">
                    <label for="url">URL</label>
                    <input type="text" id="url" placeholder="예: http://server1.example.com" required>
                </div>
                <button type="submit" class="btn btn-primary">서버 추가</button>
            </form>
        </div>
        <div class="flex-child">
            <h2>부하 분산 테스트</h2>
            <button onclick="dispatchRequest()" class="btn btn-primary">요청 보내기</button>
            <div id="log"></div>
        </div>
    </div>

    <h2>서버 목록</h2>
    <table id="server-list">
        <thead>
        <tr>
            <th>ID</th>
            <th>이름</th>
            <th>URL</th>
            <th>상태</th>
            <th>작업</th>
        </tr>
        </thead>
        <tbody>
        <!-- 서버 목록이 여기에 동적으로 추가됩니다. -->
        </tbody>
    </table>
</div>

<script>
    const API_URL = '/api/admin/servers';

    // 페이지 로드 시 서버 목록을 가져옵니다.
    document.addEventListener('DOMContentLoaded', fetchServers);

    // 서버 목록 가져오기
    async function fetchServers() {
        try {
            const response = await fetch(API_URL);
            const servers = await response.json();
            const serverListBody = document.getElementById('server-list').querySelector('tbody');
            serverListBody.innerHTML = ''; // 목록 초기화
            servers.forEach(server => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${server.id}</td>
                    <td>${server.name}</td>
                    <td>${server.url}</td>
                    <td>${server.active ? '활성' : '비활성'}</td>
                    <td>
                        <button onclick="toggleServerStatus(${server.id}, '${server.name}', '${server.url}', ${!server.active})" class="btn btn-warning btn-sm">상태 변경</button>
                        <button onclick="deleteServer(${server.id})" class="btn btn-danger btn-sm">삭제</button>
                    </td>
                `;
                serverListBody.appendChild(row);
            });
        } catch (error) {
            logMessage(`서버 목록 로딩 실패: ${error.message}`, 'red');
        }
    }

    // 서버 추가
    document.getElementById('add-server-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const name = document.getElementById('name').value;
        const url = document.getElementById('url').value;
        const newServer = { name, url, active: true };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newServer)
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            this.reset(); // 폼 초기화
            fetchServers(); // 목록 새로고침
            logMessage(`서버 추가됨: ${name}`, 'green');
        } catch (error) {
            logMessage(`서버 추가 실패: ${error.message}`, 'red');
        }
    });

    // 서버 상태 변경 (활성/비활성)
    async function toggleServerStatus(id, name, url, newStatus) {
        const serverToUpdate = { id, name, url, active: newStatus };
        try {
            const response = await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(serverToUpdate)
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            fetchServers();
            logMessage(`서버 상태 변경됨: ${name} -> ${newStatus ? '활성' : '비활성'}`, 'blue');
        } catch (error) {
            logMessage(`서버 상태 변경 실패: ${error.message}`, 'red');
        }
    }

    // 서버 삭제
    async function deleteServer(id) {
        if (!confirm(`정말로 ID ${id} 서버를 삭제하시겠습니까?`)) return;
        try {
            const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            fetchServers();
            logMessage(`서버 삭제됨: ID ${id}`, 'orange');
        } catch (error) {
            logMessage(`서버 삭제 실패: ${error.message}`, 'red');
        }
    }

    // 부하 분산 요청 보내기
    async function dispatchRequest() {
        try {
            const response = await fetch('/api/dispatch');
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            logMessage(`요청 전송됨 -> <b>${data.name}</b> (URL: ${data.url})`);
        } catch (error) {
            logMessage(`API 요청 실패: ${error.message}`, 'red');
        }
    }

    // 로그 메시지 표시
    function logMessage(message, color = 'black') {
        const logDiv = document.getElementById('log');
        logDiv.innerHTML += `<p style="color: ${color};">${message}</p>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

</script>
</body>
</html>